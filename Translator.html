<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Translator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .btn-loading {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .api-key-toggle {
            cursor: pointer;
        }
        .slide-down {
            animation: slideDown 0.3s ease-out;
        }
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideDown {
            from { 
                opacity: 0; 
                transform: translateY(-10px); 
                max-height: 0;
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
                max-height: 500px;
            }
        }
        @keyframes slideUp {
            from { 
                opacity: 1; 
                transform: translateY(0); 
                max-height: 500px;
            }
            to { 
                opacity: 0; 
                transform: translateY(-10px); 
                max-height: 0;
            }
        }
        .debug-console {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 12px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .debug-log {
            margin-bottom: 8px;
            padding: 4px;
            border-left: 3px solid #007acc;
        }
        .debug-error {
            border-left-color: #f48771;
            color: #f48771;
        }
        .debug-success {
            border-left-color: #89d185;
            color: #89d185;
        }
        .debug-warn {
            border-left-color: #dcdcaa;
            color: #dcdcaa;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex items-center justify-center">
    <div class="max-w-4xl mx-auto p-6">
        <div class="bg-white rounded-xl shadow-lg p-8 space-y-6">
            <h1 class="text-3xl font-bold text-center text-gray-800">Translator</h1>
            
            <!-- Debug Console Toggle -->
            <button 
                id="toggleDebugBtn" 
                class="w-full flex items-center justify-between bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-4 py-2 rounded-lg transition-colors"
            >
                <span>üêõ Debug Console</span>
                <svg id="debugChevron" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>

            <!-- Debug Console Section (hidden by default) -->
            <div id="debugSection" class="hidden overflow-hidden">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-2">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-medium text-yellow-800">Debug Logs</h3>
                        <button id="clearDebugBtn" class="text-xs bg-yellow-200 hover:bg-yellow-300 text-yellow-800 px-2 py-1 rounded">Clear</button>
                    </div>
                    <div id="debugConsole" class="debug-console">
                        <div class="debug-log">Ready to translate. Open browser console (F12) for detailed logs.</div>
                    </div>
                </div>
            </div>

            <!-- Translation Provider Button -->
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <div id="providerStatus" class="text-sm font-medium">
                        <span id="providerStatusText" class="text-red-600">Translation provider not configured</span>
                    </div>
                </div>
                <button 
                    id="toggleProviderBtn" 
                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors font-medium flex items-center gap-2"
                >
                    <span>Change Translation Provider</span>
                    <svg id="providerChevron" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>

            <!-- API Key Configuration (Hidden by default) -->
            <div id="apiConfigSection" class="hidden overflow-hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-3 slide-down">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-medium text-blue-800">API Configuration</h3>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="flex-1">
                                <input 
                                    type="password" 
                                    id="apiKeyInput" 
                                    placeholder="Enter your Gemini API key..." 
                                    class="w-full p-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                >
                            </div>
                            <button 
                                id="toggleApiKey" 
                                class="api-key-toggle bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-lg transition-colors flex items-center justify-center"
                                title="Show/Hide API key"
                            >
                                <svg id="eyeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                            <button 
                                id="saveApiKey" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors font-medium"
                            >
                                Save Key
                            </button>
                        </div>
                        
                        <div class="text-sm text-blue-700">
                            <p>üîë <strong>How to get your API key:</strong></p>
                            <ol class="ml-4 mt-1 list-decimal space-y-1">
                                <li>Visit <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a></li>
                                <li>Sign in with your Google account</li>
                                <li>Click "Create API key" and copy it</li>
                                <li>Paste it above and click "Save Key"</li>
                            </ol>
                            <p class="mt-2 text-xs text-blue-600">üîí Your API key is stored locally in your browser and never shared.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Language Selection -->
            <div class="flex flex-col md:flex-row items-center gap-4">
                <div class="flex-1 w-full">
                    <label class="block text-sm font-medium text-gray-700 mb-2">From</label>
                    <select id="inputLang" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="English">English</option>
                        <option value="Japanese">Japanese</option>
                        <option value="Chinese">Chinese</option>
                        <option value="Korean">Korean</option>
                        <option value="Spanish">Spanish</option>
                        <option value="French">French</option>
                        <option value="German">German</option>
                    </select>
                </div>
                
                <div class="md:mt-6">
                    <button id="swapBtn" class="p-2 text-gray-500 hover:text-blue-600 transition-colors rounded-lg hover:bg-gray-100" title="Swap languages">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="flex-1 w-full">
                    <label class="block text-sm font-medium text-gray-700 mb-2">To</label>
                    <select id="outputLang" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="English">English</option>
                        <option value="Japanese">Japanese</option>
                        <option value="Chinese">Chinese</option>
                        <option value="Korean">Korean</option>
                        <option value="Spanish">Spanish</option>
                        <option value="French">French</option>
                        <option value="German">German</option>
                    </select>
                </div>
            </div>
            
            <!-- Korean Formality and Dialect Levels -->
            <div id="formalityContainer" class="hidden space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Korean Formality Level</label>
                    <select id="formalityLevel" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="ÌïòÏÜåÏÑúÏ≤¥ (Hasoseo-che)">ÌïòÏÜåÏÑúÏ≤¥ (Hasoseo-che) ‚Äî Extremely formal, archaic</option>
                        <option value="ÌïòÏã≠ÏãúÏò§Ï≤¥ (Hasipsio-che)">ÌïòÏã≠ÏãúÏò§Ï≤¥ (Hasipsio-che) ‚Äî Formal polite</option>
                        <option value="Ìï¥ÏöîÏ≤¥ (Haeyo-che)" selected>Ìï¥ÏöîÏ≤¥ (Haeyo-che) ‚Äî Polite informal (default)</option>
                        <option value="ÌïòÍ≤åÏ≤¥ (Hage-che)">ÌïòÍ≤åÏ≤¥ (Hage-che) ‚Äî Semi-formal</option>
                        <option value="ÌïòÏò§Ï≤¥ (Hao-che)">ÌïòÏò§Ï≤¥ (Hao-che) ‚Äî Old polite</option>
                        <option value="ÌïúÎã§Ï≤¥ (Handa-che)">ÌïúÎã§Ï≤¥ (Handa-che) ‚Äî Plain/neutral</option>
                        <option value="Ìï¥Ï≤¥ (Hae-che)">Ìï¥Ï≤¥ (Hae-che) ‚Äî Casual/intimate</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Korean Dialect (Satoori)</label>
                    <select id="dialectLevel" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="Standard Korean" selected>Standard Korean (ÌëúÏ§ÄÏñ¥) ‚Äî No dialect</option>
                        <option value="Seoul/Gyeonggi Dialect">Seoul/Gyeonggi Dialect (ÏÑúÏö∏/Í≤ΩÍ∏∞ ÏÇ¨Ìà¨Î¶¨)</option>
                        <option value="Gangwon Dialect">Gangwon Dialect (Í∞ïÏõê ÏÇ¨Ìà¨Î¶¨)</option>
                        <option value="Chungcheong Dialect">Chungcheong Dialect (Ï∂©Ï≤≠ ÏÇ¨Ìà¨Î¶¨)</option>
                        <option value="Gyeongsang Dialect">Gyeongsang Dialect (Í≤ΩÏÉÅ ÏÇ¨Ìà¨Î¶¨)</option>
                        <option value="Jeolla Dialect">Jeolla Dialect (Ï†ÑÎùº ÏÇ¨Ìà¨Î¶¨)</option>
                        <option value="Jeju Dialect">Jeju Dialect (Ï†úÏ£º ÏÇ¨Ìà¨Î¶¨ / Ï†úÏ£ºÏñ¥)</option>
                    </select>
                </div>
            </div>
            
            <!-- Text Areas -->
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Input Text</label>
                    <textarea id="inputText" 
                        placeholder="Enter text to translate..." 
                        class="w-full h-40 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
                    <div id="charCount" class="text-sm text-gray-500">0 characters</div>
                </div>
                
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Translation</label>
                    <textarea id="outputText" 
                        placeholder="Translation will appear here..." 
                        class="w-full h-40 p-4 border border-gray-300 rounded-lg bg-gray-50 resize-none" 
                        readonly></textarea>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="translateBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="translateText">Translate</span>
                    <div id="loadingSpinner" class="loading-spinner hidden"></div>
                </button>
                
                <button id="copyBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 px-6 rounded-lg transition-colors">
                    Copy Translation
                </button>
                
                <button id="clearBtn" class="bg-red-100 hover:bg-red-200 text-red-700 font-medium py-3 px-6 rounded-lg transition-colors">
                    Clear
                </button>
            </div>

            <!-- Message Display -->
            <div id="messageBox" class="hidden p-4 rounded-lg text-sm"></div>
        </div>
    </div>

    <script>
        // Debug logger
        const DebugLogger = {
            log(message, type = 'info') {
                const debugConsole = document.getElementById('debugConsole');
                const timestamp = new Date().toLocaleTimeString();
                const logClass = type === 'error' ? 'debug-error' : type === 'success' ? 'debug-success' : type === 'warn' ? 'debug-warn' : '';
                const logEntry = document.createElement('div');
                logEntry.className = `debug-log ${logClass}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                debugConsole.appendChild(logEntry);
                debugConsole.scrollTop = debugConsole.scrollHeight;
                
                // Also log to browser console
                if (type === 'error') {
                    console.error(message);
                } else if (type === 'warn') {
                    console.warn(message);
                } else {
                    console.log(message);
                }
            },
            
            clear() {
                document.getElementById('debugConsole').innerHTML = '<div class="debug-log">Console cleared.</div>';
            }
        };

        // Cache DOM elements for better performance
        const elements = {
            inputLang: document.getElementById('inputLang'),
            outputLang: document.getElementById('outputLang'),
            swapBtn: document.getElementById('swapBtn'),
            inputText: document.getElementById('inputText'),
            outputText: document.getElementById('outputText'),
            translateBtn: document.getElementById('translateBtn'),
            translateText: document.getElementById('translateText'),
            loadingSpinner: document.getElementById('loadingSpinner'),
            copyBtn: document.getElementById('copyBtn'),
            clearBtn: document.getElementById('clearBtn'),
            messageBox: document.getElementById('messageBox'),
            formalityContainer: document.getElementById('formalityContainer'),
            formalityLevel: document.getElementById('formalityLevel'),
            dialectLevel: document.getElementById('dialectLevel'),
            charCount: document.getElementById('charCount'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            saveApiKey: document.getElementById('saveApiKey'),
            toggleApiKey: document.getElementById('toggleApiKey'),
            eyeIcon: document.getElementById('eyeIcon'),
            providerStatusText: document.getElementById('providerStatusText'),
            toggleProviderBtn: document.getElementById('toggleProviderBtn'),
            apiConfigSection: document.getElementById('apiConfigSection'),
            providerChevron: document.getElementById('providerChevron'),
            clearDebugBtn: document.getElementById('clearDebugBtn')
        };

        // Configuration
        const CONFIG = {
            API_URL: "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent",
            MAX_CHARS: 5000,
            DEBOUNCE_DELAY: 300,
            API_KEY_STORAGE: 'gemini_api_key'
        };

        DebugLogger.log(`Using API endpoint: ${CONFIG.API_URL}`);

        // API Key Management
        const ApiKeyManager = {
            save(apiKey) {
                try {
                    const encryptedKey = btoa(apiKey);
                    localStorage.setItem(CONFIG.API_KEY_STORAGE, encryptedKey);
                    DebugLogger.log('API key saved successfully', 'success');
                    return true;
                } catch (error) {
                    DebugLogger.log(`Failed to save API key: ${error.message}`, 'error');
                    return false;
                }
            },

            load() {
                try {
                    const encryptedKey = localStorage.getItem(CONFIG.API_KEY_STORAGE);
                    return encryptedKey ? atob(encryptedKey) : null;
                } catch (error) {
                    DebugLogger.log(`Failed to load API key: ${error.message}`, 'error');
                    return null;
                }
            },

            remove() {
                localStorage.removeItem(CONFIG.API_KEY_STORAGE);
                DebugLogger.log('API key removed', 'warn');
            },

            isValid(apiKey) {
                return apiKey && apiKey.length > 20 && apiKey.startsWith('AIza');
            }
        };

        // Utility functions
        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        const showMessage = (message, type = 'info') => {
            const colors = {
                error: 'bg-red-100 text-red-700 border-red-300',
                success: 'bg-green-100 text-green-700 border-green-300',
                info: 'bg-blue-100 text-blue-700 border-blue-300'
            };
            
            elements.messageBox.textContent = message;
            elements.messageBox.className = `p-4 rounded-lg text-sm border fade-in ${colors[type]}`;
            elements.messageBox.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => elements.messageBox.classList.add('hidden'), 3000);
            }
        };

        const setLoading = (isLoading) => {
            elements.translateBtn.disabled = isLoading;
            elements.translateBtn.classList.toggle('btn-loading', isLoading);
            elements.translateText.classList.toggle('hidden', isLoading);
            elements.loadingSpinner.classList.toggle('hidden', !isLoading);
        };

        const updateCharCount = () => {
            const count = elements.inputText.value.length;
            elements.charCount.textContent = `${count} characters`;
            elements.charCount.classList.toggle('text-red-500', count > CONFIG.MAX_CHARS);
        };

        const toggleFormalityDropdown = () => {
            const isKorean = elements.outputLang.value === 'Korean';
            elements.formalityContainer.classList.toggle('hidden', !isKorean);
        };

        const updateProviderStatus = () => {
            const apiKey = ApiKeyManager.load();
            const isConfigured = ApiKeyManager.isValid(apiKey);
            
            elements.providerStatusText.textContent = isConfigured ? 'Translator Configured ‚úì' : 'Configure Translator ‚ö†';
            elements.providerStatusText.className = isConfigured ? 'text-green-600' : 'text-red-600';
            elements.translateBtn.disabled = !isConfigured;
            
            if (isConfigured && elements.apiKeyInput.value === '') {
                elements.apiKeyInput.value = apiKey;
            }
            
            DebugLogger.log(`Provider status: ${isConfigured ? 'Configured' : 'Not configured'}`, isConfigured ? 'success' : 'warn');
        };

        const toggleProviderSection = () => {
            const isHidden = elements.apiConfigSection.classList.contains('hidden');
            
            if (isHidden) {
                elements.apiConfigSection.classList.remove('hidden');
                elements.providerChevron.style.transform = 'rotate(180deg)';
            } else {
                elements.apiConfigSection.classList.add('hidden');
                elements.providerChevron.style.transform = 'rotate(0deg)';
            }
        };

        const toggleApiKeyVisibility = () => {
            const isPassword = elements.apiKeyInput.type === 'password';
            elements.apiKeyInput.type = isPassword ? 'text' : 'password';
            
            const eyeSlashPath = 'M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L8.464 8.464M9.878 9.878l-1.415-1.414M14.12 14.12l1.415 1.415M14.12 14.12L15.535 15.535M14.12 14.12l1.415 1.415M3 3l18 18';
            const eyePath = 'M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z';
            
            elements.eyeIcon.innerHTML = isPassword ? 
                `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${eyeSlashPath}"></path>` :
                `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>`;
        };

        const saveApiKey = () => {
            const apiKey = elements.apiKeyInput.value.trim();
            
            if (!apiKey) {
                showMessage("Please enter an API key.", "error");
                DebugLogger.log('API key save failed: empty key', 'error');
                return;
            }

            if (!ApiKeyManager.isValid(apiKey)) {
                showMessage("Invalid API key format. Gemini API keys should start with 'AIza'.", "error");
                DebugLogger.log('API key save failed: invalid format', 'error');
                return;
            }

            if (ApiKeyManager.save(apiKey)) {
                showMessage("API key saved successfully!", "success");
                updateProviderStatus();
                setTimeout(() => {
                    toggleProviderSection();
                }, 1000);
            } else {
                showMessage("Failed to save API key. Please try again.", "error");
            }
        };

        // Main translation function
        const translateText = async () => {
            DebugLogger.log('=== Translation Started ===');
            
            const apiKey = ApiKeyManager.load();
            if (!ApiKeyManager.isValid(apiKey)) {
                showMessage("Please configure your translation provider first.", "error");
                DebugLogger.log('Translation failed: No valid API key', 'error');
                return;
            }

            const inputLang = elements.inputLang.value;
            const outputLang = elements.outputLang.value;
            const textToTranslate = elements.inputText.value.trim();

            DebugLogger.log(`Input language: ${inputLang}`);
            DebugLogger.log(`Output language: ${outputLang}`);
            DebugLogger.log(`Text to translate: "${textToTranslate}"`);

            if (!textToTranslate) {
                showMessage("Please enter some text to translate.", "error");
                DebugLogger.log('Translation failed: No input text', 'error');
                return;
            }

            if (textToTranslate.length > CONFIG.MAX_CHARS) {
                showMessage(`Text is too long. Maximum ${CONFIG.MAX_CHARS} characters allowed.`, "error");
                DebugLogger.log(`Translation failed: Text too long (${textToTranslate.length} chars)`, 'error');
                return;
            }

            setLoading(true);
            elements.messageBox.classList.add('hidden');

            try {
                let prompt = `You are a professional translator. Translate the following text that is between %% from ${inputLang} to ${outputLang}. Translate ALL content literally and accurately, including any profanity, slang, or colloquial expressions. Do not censor, modify, or refuse to translate any words.`;
                
                if (outputLang === 'Korean') {
                    const formality = elements.formalityLevel.value;
                    const dialect = elements.dialectLevel.value;
                    prompt += ` Use the ${formality} style`;
                    if (dialect !== 'Standard Korean') {
                        prompt += ` and translate using ${dialect} characteristics and expressions`;
                    }
                    prompt += `.`;
                    DebugLogger.log(`Korean formality: ${formality}`);
                    DebugLogger.log(`Korean dialect: ${dialect}`);
                }
                
                prompt += `\n\nText to translate: %%${textToTranslate}%%\n\nProvide ONLY the translation, no explanations.`;

                DebugLogger.log('Prompt created successfully');

                const payload = {
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.3,
                        maxOutputTokens: 2048,
                        topP: 0.95,
                        topK: 40
                    },
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                };

                DebugLogger.log('Sending request to API...');
                console.log('Full payload:', JSON.stringify(payload, null, 2));

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const response = await fetch(`${CONFIG.API_URL}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal,
                });

                clearTimeout(timeoutId);

                DebugLogger.log(`Response status: ${response.status} ${response.statusText}`);
                DebugLogger.log(`Response ok: ${response.ok}`);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error response:', errorData);
                    DebugLogger.log(`API Error: ${JSON.stringify(errorData, null, 2)}`, 'error');
                    
                    if (response.status === 400 && errorData.error?.message?.includes('API_KEY_INVALID')) {
                        showMessage("Invalid API key. Please check your key and try again.", "error");
                        ApiKeyManager.remove();
                        updateProviderStatus();
                        return;
                    }
                    throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                }

                const result = await response.json();
                
                console.log('Full API Response:', JSON.stringify(result, null, 2));
                DebugLogger.log('API Response received');
                
                // Check if response was blocked by safety filters
                if (result.promptFeedback?.blockReason) {
                    const blockReason = result.promptFeedback.blockReason;
                    DebugLogger.log(`Content blocked: ${blockReason}`, 'error');
                    throw new Error(`Content blocked by safety filters: ${blockReason}`);
                }
                
                // Try to extract the translation with better error handling
                const candidate = result.candidates?.[0];
                if (!candidate) {
                    DebugLogger.log('No candidate in API response', 'error');
                    console.log('Result structure:', result);
                    throw new Error("No candidate in API response. Check console for details.");
                }
                
                DebugLogger.log(`Candidate finish reason: ${candidate.finishReason || 'unknown'}`);
                
                if (candidate.finishReason === "SAFETY") {
                    DebugLogger.log('Translation blocked by safety filters', 'error');
                    throw new Error("Translation blocked by safety filters");
                }
                
                const translatedText = candidate.content?.parts?.[0]?.text;

                if (translatedText) {
                    DebugLogger.log('Translation successful!', 'success');
                    DebugLogger.log(`Translation: "${translatedText}"`);
                    elements.outputText.value = translatedText.trim();
                    showMessage("Translation completed successfully!", "success");
                } else {
                    DebugLogger.log('No translation text found in response', 'error');
                    console.log('Candidate structure:', candidate);
                    throw new Error(`No translation text found. Finish reason: ${candidate.finishReason || "unknown"}. Check console for details.`);
                }

            } catch (error) {
                console.error("Translation error:", error);
                DebugLogger.log(`Translation error: ${error.message}`, 'error');
                
                if (error.name === 'AbortError') {
                    showMessage("Translation timed out. Please try again.", "error");
                    DebugLogger.log('Request timed out after 30 seconds', 'error');
                } else {
                    showMessage(`Translation failed: ${error.message}`, "error");
                }
            } finally {
                setLoading(false);
                DebugLogger.log('=== Translation Ended ===');
            }
        };

        // Event handlers
        const copyText = async () => {
            const textToCopy = elements.outputText.value;
            if (!textToCopy) {
                showMessage("No text to copy.", "error");
                return;
            }

            try {
                await navigator.clipboard.writeText(textToCopy);
                showMessage("Translation copied to clipboard!", "success");
                DebugLogger.log('Text copied to clipboard', 'success');
            } catch (err) {
                showMessage("Failed to copy text. Please select and copy manually.", "error");
                DebugLogger.log('Failed to copy to clipboard', 'error');
            }
        };

        const swapLanguages = () => {
            const tempLang = elements.inputLang.value;
            elements.inputLang.value = elements.outputLang.value;
            elements.outputLang.value = tempLang;
            
            const tempText = elements.inputText.value;
            elements.inputText.value = elements.outputText.value;
            elements.outputText.value = tempText;
            
            toggleFormalityDropdown();
            updateCharCount();
            DebugLogger.log('Languages swapped');
        };

        const clearAll = () => {
            elements.inputText.value = '';
            elements.outputText.value = '';
            elements.messageBox.classList.add('hidden');
            updateCharCount();
            elements.inputText.focus();
            DebugLogger.log('Text cleared');
        };

        // Event listeners
        elements.translateBtn.addEventListener('click', translateText);
        elements.copyBtn.addEventListener('click', copyText);
        elements.swapBtn.addEventListener('click', swapLanguages);
        elements.clearBtn.addEventListener('click', clearAll);
        elements.saveApiKey.addEventListener('click', saveApiKey);
        elements.toggleApiKey.addEventListener('click', toggleApiKeyVisibility);
        elements.toggleProviderBtn.addEventListener('click', toggleProviderSection);
        elements.outputLang.addEventListener('change', toggleFormalityDropdown);
        elements.inputText.addEventListener('input', debounce(updateCharCount, 100));
        elements.clearDebugBtn.addEventListener('click', () => DebugLogger.clear());

        // Enter key shortcuts
        elements.apiKeyInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveApiKey();
            }
        });

        elements.inputText.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                translateText();
            }
        });

        // Initialize
        DebugLogger.log('Application initialized');
        toggleFormalityDropdown();
        updateCharCount();
        updateProviderStatus();
        elements.inputText.focus();

        const toggleDebugBtn = document.getElementById('toggleDebugBtn');
        const debugSection = document.getElementById('debugSection');
        const debugChevron = document.getElementById('debugChevron');

        toggleDebugBtn.addEventListener('click', () => {
            const isHidden = debugSection.classList.contains('hidden');
            if (isHidden) {
                debugSection.classList.remove('hidden');
                debugChevron.style.transform = 'rotate(180deg)';
            } else {
                debugSection.classList.add('hidden');
                debugChevron.style.transform = 'rotate(0deg)';
            }
        });

    </script>
</body>
</html>